% with xelatex
\documentclass[border=5pt]{standalone}

%\usepackage[utf8]{inputenc}
%\usepackage[T1]{fontenc}

%\usepackage{upgreek}
%\usepackage{arev}
%\usepackage{helvet}
\usepackage{tikz}
\usepackage{tkz-euclide}
%\usepackage{pst-solides3d}
%\usepackage{auto-pst-pdf}
\usetikzlibrary{calc,decorations.pathmorphing,shapes,backgrounds,arrows.meta,arrows,automata,positioning}

%\renewcommand{\familydefault}{\sfdefault}

\usepackage{xcolor}
%\definecolor{downcol}{HTML}{0000FF}
%\definecolor{upcol}{HTML}{FF0000}
%\definecolor{dotcol}{HTML}{FFFF00}
\definecolor{upcol}{HTML}{edf8b1}
\definecolor{downcol}{HTML}{2c7fb8}
\definecolor{dotcol}{HTML}{ffffff}
\definecolor{boxcol}{HTML}{eeeeee}

\usepackage{mathspec}
%\setallmainfonts{Linux Libertine O}
\setallmainfonts{Arial}

\begin{document}
\begin{tikzpicture}
  %    \path [use as bounding box] (-3.05,-4.55) rectangle (3.05,0.5);

  \def\centerarc[#1](#2)(#3:#4:#5)% Syntax: [draw options] (center) (initial angle:final angle:radius)
  { \draw[#1] ($(#2)+({#5*cos(#3)},{#5*sin(#3)})$) arc (#3:#4:#5); }
  \def\c{1.5/3}
  \def\d{1.5/5}
  \def\r{0.12*\c}
  \def\h{1}

  \def\myarray{{"2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","edf8b1","2c7fb8","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","edf8b1","2c7fb8","edf8b1","2c7fb8","edf8b1","edf8b1","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","2c7fb8","edf8b1","edf8b1","edf8b1","edf8b1","2c7fb8","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8","2c7fb8","edf8b1","2c7fb8"}}

  % leftmost square, large block

  %    \draw (-3.0,-3.0) to (-1.57,-0.62);
  %    \draw (-1.5,-3.0) to (-0.86,-1.07);
  %    \draw (-3.0,-4.5) to (-2.15,-1.41);
  %    \draw (-1.5,-4.5) to (-1.19,-2.03);
  %    \fill[fill=white] (-3.0,-3.0) rectangle (-1.5,-4.5);

  %\fill[fill=upcol] (-3,-4.5) rectangle (-3+2*\c,-4.5+4*\c);
  %\fill[fill=downcol] (-3+2*\c,-4.5) rectangle (-3+4*\c,-4.5+4*\c);
  %\draw[line width=0.5pt, dashed] (-3.0,-3.0) rectangle (-1.5,-4.5);


  % boxes for component processes
  \fill[fill=boxcol, rounded corners] (-8.5,-10) rectangle (-1,-1);
  \node at (-4.5, -1.5) {\large Vertical process ($1-q$)};

  \fill[fill=boxcol, rounded corners] (-8.5,-20) rectangle (-1,-11);
  \node at (-4.5, -11.5) {\large Horizontal process ($q$)};

  % big lattice
  \foreach \x in {0,1,...,14}{
    \foreach \y in {0,1,...,14}{
      \pgfmathparse{\myarray[\x*14 + \y]};
      \definecolor{currcol}{HTML}{\pgfmathresult};
      \fill[fill=currcol] (-3 - 13 + \d*\x, -4.5 - 7.5 - 1 + \d*\y) rectangle (-3 + \d - 13 + \d*\x, -4.5 + \d - 7.5 - 1 + \d*\y);
      %\fill[fill=upcol] (-3 - 13 + \d*\x, -4.5 - 7.5 - 1 + \d*\y) rectangle (-3 + \d - 13 + \d*\x, -4.5 + \d - 7.5 - 1 + \d*\y);
    }
  }

  % "zoom lines"
  \draw[-, color=black] (-3-13+\d*1, -4.5-7.5-1+\d*14) -- (-8.0, -4.0 + \h);
  \draw[-, color=black] (-3-13+\d*4, -4.5-7.5-1+\d*11) -- (-6.5, -5.5 + \h);

  \draw[-, color=black] (-3-13+\d*11, -4.5-7.5-1+\d*13) -- (-8.0, -8.0 + \h);
  \draw[-, color=black] (-3-13+\d*14, -4.5-7.5-1+\d*10) -- (-6.5, -9.5 + \h);

  \draw[-, color=black] (-3-13+\d*14, -4.5-7.5-1+\d*4) -- (-6.5, -12.0 - \h);
  \draw[-, color=black] (-3-13+\d*11, -4.5-7.5-1+\d*1) -- (-8.0, -13.5 - \h);

  \draw[-, color=black] (-3-13+\d*1, -4.5-7.5-1+\d*0) -- (-8.0, -17.5 - \h);
  \draw[-, color=black] (-3-13+\d*4, -4.5-7.5-1+\d*3) -- (-6.5, -16.0 - \h);

  % dashed rectangles for big lattice
  \draw[dashed, line width=0.9pt] (-3-13+\d*1, -4.5-7.5-1+\d*14) rectangle (-3-13+\d*4, -4.5-7.5-1+\d*11);
  \draw[dashed, line width=0.9pt] (-3-13+\d*11, -4.5-7.5-1+\d*13) rectangle (-3-13+\d*14, -4.5-7.5-1+\d*10);
  \draw[dashed, line width=0.9pt] (-3-13+\d*14, -4.5-7.5-1+\d*4) rectangle (-3-13+\d*11, -4.5-7.5-1+\d*1);
  \draw[dashed, line width=0.9pt] (-3-13+\d*1, -4.5-7.5-1+\d*0) rectangle (-3-13+\d*4, -4.5-7.5-1+\d*3);

  % legend
  \def\lh{0.6}
  \def\lv{0.24}
  \def\lsep{0.7}
  \def\lorigin{-17.7}

  \fill[fill=downcol] (-16, \lorigin) rectangle (-16 + \c, \lorigin + \c);
  \draw[line width=0.3pt] (-16, \lorigin) rectangle (-16 + \c, \lorigin + \c);
  \node[right] at (-16 + \lh, \lorigin + \lv) {feature present};

  \fill[fill=upcol] (-16, \lorigin - \lsep) rectangle (-16 + \c, \lorigin - \lsep + \c);
  \draw[line width=0.3pt] (-16, \lorigin - \lsep) rectangle (-16 + \c, \lorigin - \lsep + \c);
  \node[right] at (-16 + \lh, \lorigin - \lsep + \lv) {feature absent};

  \draw[line width=2pt] (-16, \lorigin - 2*\lsep) rectangle (-16 + \c, \lorigin - 2*\lsep + \c);
  \node[right] at (-16 + \lh, \lorigin - 2*\lsep + \lv) {language chosen for update};

  \draw[line width=2pt] (-16, \lorigin - 3*\lsep) rectangle (-16 + \c, \lorigin - 3*\lsep + \c);
  \node[right] at (-16 + \lh, \lorigin - 3*\lsep + \lv) {horizontal interaction};
  \draw[->, line width=1.2pt] (-16 - 0.5*\c, \lorigin - 3*\lsep + \lv) -- (-16 + 0.6*\c, \lorigin - 3*\lsep + \lv);


  % squares, second (right) column
  \def\y{0}
  \fill[fill=upcol] (-3, -4.5 - 2*\y + \h) rectangle (-3 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-3, -4.0 - 2*\y + \h) rectangle (-3 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-3, -3.5 - 2*\y + \h) rectangle (-3 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.5, -4.5 - 2*\y + \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.5, -4.0 - 2*\y + \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -3.5 - 2*\y + \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.0, -4.5 - 2*\y + \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.0, -4.0 - 2*\y + \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.0, -3.5 - 2*\y + \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y + \h);

  \def\y{1}
  \fill[fill=upcol] (-3, -4.5 - 2*\y + \h) rectangle (-3 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-3, -4.0 - 2*\y + \h) rectangle (-3 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-3, -3.5 - 2*\y + \h) rectangle (-3 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.5, -4.5 - 2*\y + \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -4.0 - 2*\y + \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -3.5 - 2*\y + \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.0, -4.5 - 2*\y + \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.0, -4.0 - 2*\y + \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.0, -3.5 - 2*\y + \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y + \h);

  \def\y{2}
  \fill[fill=downcol] (-3, -4.5 - 2*\y + \h) rectangle (-3 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-3, -4.0 - 2*\y + \h) rectangle (-3 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=upcol] (-3, -3.5 - 2*\y + \h) rectangle (-3 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -4.5 - 2*\y + \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -4.0 - 2*\y + \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -3.5 - 2*\y + \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.0, -4.5 - 2*\y + \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.0, -4.0 - 2*\y + \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.0, -3.5 - 2*\y + \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y + \h);

  \def\y{3}
  \fill[fill=downcol] (-3, -4.5 - 2*\y + \h) rectangle (-3 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-3, -4.0 - 2*\y + \h) rectangle (-3 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=upcol] (-3, -3.5 - 2*\y + \h) rectangle (-3 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -4.5 - 2*\y + \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.5, -4.0 - 2*\y + \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.5, -3.5 - 2*\y + \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.0, -4.5 - 2*\y + \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y + \h);
  \fill[fill=downcol] (-2.0, -4.0 - 2*\y + \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y + \h);
  \fill[fill=upcol] (-2.0, -3.5 - 2*\y + \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y + \h);

  \def\y{4}
  \fill[fill=upcol] (-3, -4.5 - 2*\y - \h) rectangle (-3 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-3, -4.0 - 2*\y - \h) rectangle (-3 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-3, -3.5 - 2*\y - \h) rectangle (-3 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.5, -4.5 - 2*\y - \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.5, -4.0 - 2*\y - \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.5, -3.5 - 2*\y - \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.0, -4.5 - 2*\y - \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.0, -4.0 - 2*\y - \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.0, -3.5 - 2*\y - \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y - \h);

  \def\y{5}
  \fill[fill=upcol] (-3, -4.5 - 2*\y - \h) rectangle (-3 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-3, -4.0 - 2*\y - \h) rectangle (-3 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-3, -3.5 - 2*\y - \h) rectangle (-3 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.5, -4.5 - 2*\y - \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.5, -4.0 - 2*\y - \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.5, -3.5 - 2*\y - \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.0, -4.5 - 2*\y - \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.0, -4.0 - 2*\y - \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.0, -3.5 - 2*\y - \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y - \h);

  \def\y{6}
  \fill[fill=downcol] (-3, -4.5 - 2*\y - \h) rectangle (-3 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-3, -4.0 - 2*\y - \h) rectangle (-3 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-3, -3.5 - 2*\y - \h) rectangle (-3 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.5, -4.5 - 2*\y - \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.5, -4.0 - 2*\y - \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.5, -3.5 - 2*\y - \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.0, -4.5 - 2*\y - \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.0, -4.0 - 2*\y - \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.0, -3.5 - 2*\y - \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y - \h);

  \def\y{7}
  \fill[fill=downcol] (-3, -4.5 - 2*\y - \h) rectangle (-3 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-3, -4.0 - 2*\y - \h) rectangle (-3 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-3, -3.5 - 2*\y - \h) rectangle (-3 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.5, -4.5 - 2*\y - \h) rectangle (-2.5 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.5, -4.0 - 2*\y - \h) rectangle (-2.5 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.5, -3.5 - 2*\y - \h) rectangle (-2.5 + \c, -3.5 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.0, -4.5 - 2*\y - \h) rectangle (-2.0 + \c, -4.5 + \c - 2*\y - \h);
  \fill[fill=upcol] (-2.0, -4.0 - 2*\y - \h) rectangle (-2.0 + \c, -4.0 + \c - 2*\y - \h);
  \fill[fill=downcol] (-2.0, -3.5 - 2*\y - \h) rectangle (-2.0 + \c, -3.5 + \c - 2*\y - \h);


  % squares, first (left) column
  \def\y{0}
  \fill[fill=upcol] (-3 - 5, -4.5 - 4*\y - 1 + \h) rectangle (-3 + \c - 5, -4.5 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-3 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-3 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-3 - 5, -3.5 - 4*\y - 1 + \h) rectangle (-3 + \c - 5, -3.5 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-2.5 - 5, -4.5 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -4.5 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.5 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.5 - 5, -3.5 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -3.5 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-2.0 - 5, -4.5 - 4*\y - 1 + \h) rectangle (-2.0 + \c - 5, -4.5 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.0 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-2.0 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.0 - 5, -3.5 - 4*\y - 1 + \h) rectangle (-2.0 + \c - 5, -3.5 + \c - 4*\y - 1 + \h);
  \draw[line width=2pt] (-2.5 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);

  \def\y{1}
  \fill[fill=downcol] (-3 - 5, -4.5 - 4*\y - 1 + \h) rectangle (-3 + \c - 5, -4.5 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-3 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-3 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-3 - 5, -3.5 - 4*\y - 1 + \h) rectangle (-3 + \c - 5, -3.5 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.5 - 5, -4.5 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -4.5 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-2.5 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.5 - 5, -3.5 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -3.5 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-2.0 - 5, -4.5 - 4*\y - 1 + \h) rectangle (-2.0 + \c - 5, -4.5 + \c - 4*\y - 1 + \h);
  \fill[fill=downcol] (-2.0 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-2.0 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);
  \fill[fill=upcol] (-2.0 - 5, -3.5 - 4*\y - 1 + \h) rectangle (-2.0 + \c - 5, -3.5 + \c - 4*\y - 1 + \h);
  \draw[line width=2pt] (-2.5 - 5, -4.0 - 4*\y - 1 + \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 + \h);

  \def\y{2}
  \fill[fill=upcol] (-3 - 5, -4.5 - 4*\y - 1 - \h) rectangle (-3 + \c - 5, -4.5 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-3 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-3 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-3 - 5, -3.5 - 4*\y - 1 - \h) rectangle (-3 + \c - 5, -3.5 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-2.5 - 5, -4.5 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -4.5 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-2.5 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-2.5 - 5, -3.5 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -3.5 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-2.0 - 5, -4.5 - 4*\y - 1 - \h) rectangle (-2.0 + \c - 5, -4.5 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-2.0 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-2.0 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-2.0 - 5, -3.5 - 4*\y - 1 - \h) rectangle (-2.0 + \c - 5, -3.5 + \c - 4*\y - 1 - \h);
  \draw[line width=2pt] (-2.5 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  %\draw[->, line width=1.2pt] (-2.5 - 5 + 0.5*\c, -4.0 - 4*\y - 1 + 1.5*\c - \h) -- (-2.5 + \c - 5 - 0.5*\c, -4.0 + \c - 4*\y - 1 - 0.5*\c - \h);
  \draw[->, line width=1.2pt] (-2.5 - 5 + 0.5*\c - \c, -4.0 - 4*\y - 1 + 1.5*\c - \c - \h) -- (-2.5 + \c - 5 - 0.4*\c, -4.0 + \c - 4*\y - 1 - 0.5*\c - \h);

  \def\y{3}
  \fill[fill=downcol] (-3 - 5, -4.5 - 4*\y - 1 - \h) rectangle (-3 + \c - 5, -4.5 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-3 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-3 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-3 - 5, -3.5 - 4*\y - 1 - \h) rectangle (-3 + \c - 5, -3.5 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-2.5 - 5, -4.5 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -4.5 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-2.5 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-2.5 - 5, -3.5 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -3.5 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-2.0 - 5, -4.5 - 4*\y - 1 - \h) rectangle (-2.0 + \c - 5, -4.5 + \c - 4*\y - 1 - \h);
  \fill[fill=upcol] (-2.0 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-2.0 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \fill[fill=downcol] (-2.0 - 5, -3.5 - 4*\y - 1 - \h) rectangle (-2.0 + \c - 5, -3.5 + \c - 4*\y - 1 - \h);
  \draw[line width=2pt] (-2.5 - 5, -4.0 - 4*\y - 1 - \h) rectangle (-2.5 + \c - 5, -4.0 + \c - 4*\y - 1 - \h);
  \draw[->, line width=1.2pt] (-2.5 - 5 + 0.5*\c, -4.0 - 4*\y - 1 + 1.5*\c - \h) -- (-2.5 + \c - 5 - 0.5*\c, -4.0 + \c - 4*\y - 1 - 0.6*\c - \h);





  % labels
  \node at (-5,-3.75 + \h) {$p_E$};
  \node at (-5,-5.75 + \h) {$1 - p_E$};
  \node at (-5,-3.75-4 + \h) {$p_I$};
  \node at (-5,-5.75-4 + \h) {$1 - p_I$};
  \node at (-5,-3.75-8 - \h) {$p_I'$};
  \node at (-5,-5.75-8 - \h) {$1 - p_I'$};
  \node at (-5,-3.75-12 - \h) {$p_E'$};
  \node at (-5,-5.75-12 - \h) {$1 - p_E'$};


  \foreach \y in {0,1,...,3}{
    \draw[dashed,line width=0.7pt] (-3.0,-3.0 - 2*\y + \h) rectangle (-1.5,-4.5 - 2*\y + \h);
    \foreach \x in {1,...,2}{
      \draw[line width=0.3pt] (-3 + \x*\c, -4.5 - 2*\y + \h) -- (-3 + \x*\c, -3 - 2*\y + \h);
      \draw[line width=0.3pt] (-1.5, -4.5 + \x*\c - 2*\y + \h) -- (-3, -4.5 + \x*\c - 2*\y + \h);
    }
  }

  \foreach \y in {4,...,7}{
    \draw[dashed,line width=0.7pt] (-3.0,-3.0 - 2*\y - \h) rectangle (-1.5,-4.5 - 2*\y - \h);
    \foreach \x in {1,...,2}{
      \draw[line width=0.3pt] (-3 + \x*\c, -4.5 - 2*\y - \h) -- (-3 + \x*\c, -3 - 2*\y - \h);
      \draw[line width=0.3pt] (-1.5, -4.5 + \x*\c - 2*\y - \h) -- (-3, -4.5 + \x*\c - 2*\y - \h);
    }
  }


  \foreach \y in {0,...,1}{
    \draw[dashed,line width=0.7pt] (-8.0,-4.0 - 4*\y + \h) rectangle (-6.5,-5.5 - 4*\y + \h);
    \foreach \x in {1,...,2}{
      \draw[line width=0.3pt] (-8 + \x*\c, -5.5 - 4*\y + \h) -- (-8 + \x*\c, -4 - 4*\y + \h);
      \draw[line width=0.3pt] (-6.5, -5.5 + \x*\c - 4*\y + \h) -- (-8, -5.5 + \x*\c - 4*\y + \h);
    }
  }

  \foreach \y in {2,...,3}{
    \draw[dashed,line width=0.7pt] (-8.0,-4.0 - 4*\y - \h) rectangle (-6.5,-5.5 - 4*\y - \h);
    \foreach \x in {1,...,2}{
      \draw[line width=0.3pt] (-8 + \x*\c, -5.5 - 4*\y - \h) -- (-8 + \x*\c, -4 - 4*\y - \h);
      \draw[line width=0.3pt] (-6.5, -5.5 + \x*\c - 4*\y - \h) -- (-8, -5.5 + \x*\c - 4*\y - \h);
    }
  }



  % arrows
  \foreach \x in {0,...,1}{
    \draw[->, line width=0.8pt] (-6, -4.75 - 4*\x + \h) -- (-3.5,-3.75 - 4*\x + \h);
    \draw[->, line width=0.8pt] (-6, -4.75 - 4*\x + \h) -- (-3.5,-5.75 - 4*\x + \h);
  }

  \foreach \x in {2,...,3}{
    \draw[->, line width=0.8pt] (-6, -4.75 - 4*\x - \h) -- (-3.5,-3.75 - 4*\x - \h);
    \draw[->, line width=0.8pt] (-6, -4.75 - 4*\x - \h) -- (-3.5,-5.75 - 4*\x - \h);
  }







  %\foreach \x in {0,1,...,3}{
  %    \draw[black,fill=dotcol,line width=0.5pt] (-3+2*\c,-4.5+\x*\c+0.5*\c) circle (\r);
  %}



\end{tikzpicture}
\end{document}

